-- ESP + Hitbox com Menu (CoreGui) - nome "lxzinn__", toggle K para mostrar/ocultar
-- Copie somente o conteúdo deste bloco (não copie as linhas de código-fence do Markdown)

-- =========================
-- Configurações iniciais
-- =========================
getgenv().ESPSettings = getgenv().ESPSettings or {
    Enabled = true,
    ShowLocal = false,
    MaxDistance = 2000,
    UpdateRate = 0, -- 0 = RenderStepped
    ShowNPCs = true,
    KeybindToggle = Enum.KeyCode.RightControl,
    BillboardName = "ESP_Billboard_v1",
    MaxNameLength = 12,
}

getgenv().HitboxSettings = getgenv().HitboxSettings or {
    Enabled = true,
    hitboxSize = 10,
    updateRate = 0.1,
    HitboxPartName = "ESP_Hitbox_Part",
    OriginalHeadName = "OriginalHead",
}

local ESP = getgenv().ESPSettings
local HB = getgenv().HitboxSettings

-- Serviços
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

-- Nome do menu (conforme pedido)
local MENU_NAME = "lxzinn__"
local menuScreen -- referência para o ScreenGui

-- UTIL
local function shortenName(name, maxLen)
    if not name then return "" end
    maxLen = maxLen or 12
    if #name > maxLen then
        return string.sub(name, 1, maxLen - 3) .. "..."
    end
    return name
end

-- =========================
-- ESP
-- =========================
local function createBillboardForHead(head)
    if not head or not head:IsA("BasePart") then return nil end
    local existing = head:FindFirstChild(ESP.BillboardName)
    if existing and existing:IsA("BillboardGui") then
        return existing
    end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = ESP.BillboardName
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 140, 0, 28)
    billboard.StudsOffset = Vector3.new(0, 2.2, 0)
    billboard.AlwaysOnTop = true
    billboard.ResetOnSpawn = false

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    label.TextStrokeTransparency = 0
    label.Font = Enum.Font.GothamBold
    label.TextScaled = false
    label.TextSize = 16
    label.RichText = false
    label.Text = ""
    label.Parent = billboard

    billboard.Parent = head
    return billboard
end

local function cleanupOrphanBillboards()
    for _, part in ipairs(workspace:GetDescendants()) do
        if part:IsA("BasePart") then
            local bb = part:FindFirstChild(ESP.BillboardName)
            if bb and bb:IsA("BillboardGui") then
                local parentModel = part.Parent
                local ok = false
                if parentModel and parentModel:IsA("Model") then
                    if parentModel:FindFirstChildOfClass("Humanoid") then
                        ok = true
                    end
                end
                if not ok then
                    bb:Destroy()
                end
            end
        end
    end
end

local function collectTargets()
    local targets = {}

    for _, pl in ipairs(Players:GetPlayers()) do
        if pl ~= LocalPlayer or ESP.ShowLocal then
            local char = pl.Character
            if char and char.Parent then
                local head = char:FindFirstChild("Head") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso")
                if head and head:IsA("BasePart") then
                    table.insert(targets, {type = "player", player = pl, model = char, head = head})
                end
            end
        end
    end

    if ESP.ShowNPCs then
        for _, model in ipairs(workspace:GetChildren()) do
            if model:IsA("Model") and not Players:GetPlayerFromCharacter(model) then
                if model:FindFirstChildOfClass("Humanoid") then
                    local head = model:FindFirstChild("Head") or model:FindFirstChild("Torso") or model:FindFirstChild("UpperTorso")
                    if head and head:IsA("BasePart") then
                        table.insert(targets, {type = "npc", model = model, head = head})
                    end
                end
            end
        end
    end

    return targets
end

local function updateBillboard(target)
    if not target or not target.head or not target.head.Parent then return end
    local head = target.head
    local billboard = createBillboardForHead(head)
    if not billboard then return end
    local label = billboard:FindFirstChild("Label")
    if not label then return end

    local pos = head.Position
    local txtParts = {}

    if target.type == "player" and target.player then
        table.insert(txtParts, shortenName(target.player.Name, ESP.MaxNameLength))
    elseif target.type == "npc" and target.model then
        table.insert(txtParts, shortenName(target.model.Name, ESP.MaxNameLength))
    else
        table.insert(txtParts, "Model")
    end

    if LocalPlayer and LocalPlayer.Character and LocalPlayer.Character.PrimaryPart and ESP.MaxDistance and ESP.MaxDistance > 0 then
        local myPos = LocalPlayer.Character.PrimaryPart.Position
        local dist = (pos - myPos).Magnitude
        if ESP.MaxDistance and dist > ESP.MaxDistance then
            billboard.Enabled = false
            return
        end
    end

    billboard.Enabled = ESP.Enabled
    label.Text = table.concat(txtParts, "  |  ")
end

local function updateAllESP()
    cleanupOrphanBillboards()
    local targets = collectTargets()
    for _, t in ipairs(targets) do
        pcall(updateBillboard, t)
    end
end

-- =========================
-- HITBOX (fix)
-- =========================
local modifiedCharacters = {} -- character -> { hitboxPart = Instance, headClone = Instance, originalHeadProps = {} }

local function isAlreadyModified(character)
    if not character then return false end
    for _, v in ipairs(character:GetDescendants()) do
        if v:IsA("BasePart") and v.Name == HB.HitboxPartName then
            return true
        end
    end
    return false
end

local function transformHead(character)
    if not character or not character.Parent then return end
    local head = character:FindFirstChild("Head")
    if not head or not head:IsA("BasePart") then return end
    if isAlreadyModified(character) then
        for _, v in ipairs(character:GetDescendants()) do
            if v:IsA("BasePart") and v.Name == HB.HitboxPartName then
                v.Size = Vector3.new(HB.hitboxSize, HB.hitboxSize, HB.hitboxSize)
                v.CFrame = head.CFrame
            end
        end
        return
    end

    local hitboxPart = Instance.new("Part")
    hitboxPart.Name = HB.HitboxPartName
    hitboxPart.Size = Vector3.new(HB.hitboxSize, HB.hitboxSize, HB.hitboxSize)
    hitboxPart.Shape = Enum.PartType.Ball
    hitboxPart.Transparency = 1
    hitboxPart.CanCollide = false
    hitboxPart.Anchored = false
    hitboxPart.Massless = true
    hitboxPart.CFrame = head.CFrame
    hitboxPart.Parent = character

    local weldToHead = Instance.new("WeldConstraint")
    weldToHead.Part0 = hitboxPart
    weldToHead.Part1 = head
    weldToHead.Parent = hitboxPart

    local headClone = head:Clone()
    headClone.Name = HB.OriginalHeadName
    for _, child in ipairs(headClone:GetDescendants()) do
        if child:IsA("Motor6D") or child:IsA("Weld") then
            child:Destroy()
        end
    end
    headClone.Parent = hitboxPart
    headClone.CFrame = head.CFrame

    local weldClone = Instance.new("WeldConstraint")
    weldClone.Part0 = headClone
    weldClone.Part1 = hitboxPart
    weldClone.Parent = headClone

    local originalHeadProps = {
        Size = head.Size,
        Transparency = head.Transparency,
        CanCollide = head.CanCollide,
        Anchored = head.Anchored,
        Massless = head.Massless,
    }

    head.Transparency = 1
    head.CanCollide = false
    head.Massless = true

    modifiedCharacters[character] = {
        hitboxPart = hitboxPart,
        headClone = headClone,
        originalHeadProps = originalHeadProps,
    }
end

local function restoreHead(character)
    if not character or not modifiedCharacters[character] then return end
    local data = modifiedCharacters[character]
    if data.hitboxPart and data.hitboxPart.Parent then
        data.hitboxPart:Destroy()
    end
    local head = character:FindFirstChild("Head")
    if head and data.originalHeadProps then
        head.Size = data.originalHeadProps.Size or head.Size
        head.Transparency = data.originalHeadProps.Transparency or 0
        head.CanCollide = data.originalHeadProps.CanCollide or false
        head.Anchored = data.originalHeadProps.Anchored or false
        head.Massless = data.originalHeadProps.Massless or false
    end
    modifiedCharacters[character] = nil
end

local function updateAllHitboxes()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local char = player.Character
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then
                if hum.Sit then
                    restoreHead(char)
                else
                    if HB.Enabled then
                        pcall(transformHead, char)
                        local data = modifiedCharacters[char]
                        if data and data.hitboxPart and data.hitboxPart:IsA("BasePart") then
                            data.hitboxPart.Size = Vector3.new(HB.hitboxSize, HB.hitboxSize, HB.hitboxSize)
                        end
                        if data and data.hitboxPart and data.hitboxPart:IsA("BasePart") then
                            local head = char:FindFirstChild("Head")
                            if head then
                                data.hitboxPart.CFrame = head.CFrame
                            end
                        end
                    else
                        restoreHead(char)
                    end
                end
            end
        end
    end
end

-- =========================
-- Eventos e loops
-- =========================
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(char)
        task.wait(1)
        if HB.Enabled then
            pcall(transformHead, char)
        end
        if ESP.Enabled then
            pcall(updateAllESP)
        end
    end)
    player.CharacterRemoving:Connect(function(char)
        modifiedCharacters[char] = nil
    end)
end)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == ESP.KeybindToggle then
        ESP.Enabled = not ESP.Enabled
        getgenv().ESPSettings.Enabled = ESP.Enabled
        updateAllESP()
    end
end)

if ESP.UpdateRate and ESP.UpdateRate > 0 then
    spawn(function()
        while true do
            if ESP.Enabled then updateAllESP() end
            wait(ESP.UpdateRate)
        end
    end)
else
    RunService.RenderStepped:Connect(function()
        if ESP.Enabled then
            pcall(updateAllESP)
        end
    end)
end

task.spawn(function()
    while task.wait(HB.updateRate) do
        if HB.Enabled then
            pcall(updateAllHitboxes)
        else
            for char, _ in pairs(modifiedCharacters) do
                pcall(restoreHead, char)
            end
        end
    end
end)

-- Inicialização
task.spawn(function()
    task.wait(1)
    updateAllESP()
    updateAllHitboxes()
end)

-- =========================
-- MENU (CoreGui) - nome "lxzinn__" e toggle por K
-- =========================
local function createMenu()
    -- Remove menu antigo com mesmo nome (se existir)
    local existing = CoreGui:FindFirstChild(MENU_NAME)
    if existing then existing:Destroy() end

    local screen = Instance.new("ScreenGui")
    screen.Name = MENU_NAME
    screen.ResetOnSpawn = false
    screen.Enabled = true
    screen.Parent = CoreGui
    menuScreen = screen

    local frame = Instance.new("Frame")
    frame.Name = "Main"
    frame.Size = UDim2.new(0, 280, 0, 160)
    frame.Position = UDim2.new(0.5, -140, 0.2, 0)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.Parent = screen
    frame.Active = true
    frame.Draggable = true

    local uicorner = Instance.new("UICorner")
    uicorner.CornerRadius = UDim.new(0, 8)
    uicorner.Parent = frame

    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, 0, 0, 28)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "lxzinn__ Menu"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Parent = frame

    local espBtn = Instance.new("TextButton")
    espBtn.Name = "ESPButton"
    espBtn.Size = UDim2.new(0, 120, 0, 36)
    espBtn.Position = UDim2.new(0, 12, 0, 36)
    espBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    espBtn.BorderSizePixel = 0
    espBtn.Font = Enum.Font.Gotham
    espBtn.TextSize = 14
    espBtn.TextColor3 = Color3.fromRGB(255,255,255)
    espBtn.Text = (ESP.Enabled and "ESP: ON" or "ESP: OFF")
    espBtn.Parent = frame

    local hitBtn = Instance.new("TextButton")
    hitBtn.Name = "HitboxButton"
    hitBtn.Size = UDim2.new(0, 120, 0, 36)
    hitBtn.Position = UDim2.new(0, 148, 0, 36)
    hitBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    hitBtn.BorderSizePixel = 0
    hitBtn.Font = Enum.Font.Gotham
    hitBtn.TextSize = 14
    hitBtn.TextColor3 = Color3.fromRGB(255,255,255)
    hitBtn.Text = (HB.Enabled and "Hitbox: ON" or "Hitbox: OFF")
    hitBtn.Parent = frame

    local sizeLabel = Instance.new("TextLabel")
    sizeLabel.Name = "SizeLabel"
    sizeLabel.Size = UDim2.new(0, 80, 0, 24)
    sizeLabel.Position = UDim2.new(0, 12, 0, 84)
    sizeLabel.BackgroundTransparency = 1
    sizeLabel.Text = "Hitbox Size:"
    sizeLabel.Font = Enum.Font.Gotham
    sizeLabel.TextSize = 14
    sizeLabel.TextColor3 = Color3.fromRGB(200,200,200)
    sizeLabel.TextXAlignment = Enum.TextXAlignment.Left
    sizeLabel.Parent = frame

    local sizeBox = Instance.new("TextBox")
    sizeBox.Name = "SizeBox"
    sizeBox.Size = UDim2.new(0, 120, 0, 28)
    sizeBox.Position = UDim2.new(0, 100, 0, 80)
    sizeBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    sizeBox.BorderSizePixel = 0
    sizeBox.Font = Enum.Font.Gotham
    sizeBox.TextSize = 14
    sizeBox.TextColor3 = Color3.fromRGB(255,255,255)
    sizeBox.Text = tostring(HB.hitboxSize)
    sizeBox.ClearTextOnFocus = false
    sizeBox.Parent = frame

    local applyBtn = Instance.new("TextButton")
    applyBtn.Name = "ApplyButton"
    applyBtn.Size = UDim2.new(0, 60, 0, 28)
    applyBtn.Position = UDim2.new(0, 228, 0, 80)
    applyBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    applyBtn.BorderSizePixel = 0
    applyBtn.Font = Enum.Font.Gotham
    applyBtn.TextSize = 14
    applyBtn.TextColor3 = Color3.fromRGB(255,255,255)
    applyBtn.Text = "Aplicar"
    applyBtn.Parent = frame

    local closeBtn = Instance.new("TextButton")
    closeBtn.Name = "Close"
    closeBtn.Size = UDim2.new(0, 60, 0, 22)
    closeBtn.Position = UDim2.new(1, -70, 0, 6)
    closeBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
    closeBtn.BorderSizePixel = 0
    closeBtn.Font = Enum.Font.Gotham
    closeBtn.TextSize = 12
    closeBtn.TextColor3 = Color3.fromRGB(255,255,255)
    closeBtn.Text = "Fechar"
    closeBtn.Parent = frame

    espBtn.MouseButton1Click:Connect(function()
        ESP.Enabled = not ESP.Enabled
        getgenv().ESPSettings.Enabled = ESP.Enabled
        espBtn.Text = (ESP.Enabled and "ESP: ON" or "ESP: OFF")
        updateAllESP()
    end)

    hitBtn.MouseButton1Click:Connect(function()
        HB.Enabled = not HB.Enabled
        getgenv().HitboxSettings.Enabled = HB.Enabled
        hitBtn.Text = (HB.Enabled and "Hitbox: ON" or "Hitbox: OFF")
        if not HB.Enabled then
            for char, _ in pairs(modifiedCharacters) do
                pcall(restoreHead, char)
            end
        else
            for _, pl in pairs(Players:GetPlayers()) do
                if pl ~= LocalPlayer and pl.Character then
                    pcall(transformHead, pl.Character)
                end
            end
        end
    end)

    applyBtn.MouseButton1Click:Connect(function()
        local text = sizeBox.Text
        local num = tonumber(text)
        if num and num > 0 then
            HB.hitboxSize = num
            getgenv().HitboxSettings.hitboxSize = num
            for char, data in pairs(modifiedCharacters) do
                if data and data.hitboxPart and data.hitboxPart:IsA("BasePart") then
                    data.hitboxPart.Size = Vector3.new(num, num, num)
                end
            end
        else
            sizeBox.Text = tostring(HB.hitboxSize)
        end
    end)

    -- fechar apenas esconde o menu (Enabled = false)
    closeBtn.MouseButton1Click:Connect(function()
        if menuScreen and menuScreen.Parent then
            menuScreen.Enabled = false
        end
    end)

    return screen
end

-- Cria menu inicialmente (tenta em CoreGui)
local function ensureMenu()
    if menuScreen and menuScreen.Parent and menuScreen.Enabled ~= nil then
        return menuScreen
    end
    local ok, err = pcall(function()
        createMenu()
    end)
    if not ok then
        warn("[ESP+HITBOX] Não foi possível criar menu em CoreGui:", err)
        -- fallback em PlayerGui
        local fallback = Instance.new("ScreenGui")
        fallback.Name = MENU_NAME
        fallback.ResetOnSpawn = false
        fallback.Parent = LocalPlayer:WaitForChild("PlayerGui")
        menuScreen = fallback
        warn("[ESP+HITBOX] Fallback do menu criado em PlayerGui.")
    end
    return menuScreen
end

-- Toggle do menu via tecla K
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.K then
        -- Se menu existir, toggle Enabled; se não, cria
        if menuScreen and menuScreen.Parent then
            menuScreen.Enabled = not menuScreen.Enabled
        else
            ensureMenu()
            if menuScreen and menuScreen.Parent then
                menuScreen.Enabled = true
            end
        end
    end
end)

-- Garante criação inicial do menu
ensureMenu()

print("[ESP+HITBOX] Inicializado. Menu nome:", MENU_NAME, "Use K para mostrar/ocultar o menu. ESP:", tostring(ESP.Enabled), "Hitbox:", tostring(HB.Enabled))
