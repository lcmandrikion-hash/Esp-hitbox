-- ESP + Hitbox com Menu (CoreGui) - Versão completa e funcional
-- Nome do menu: "lxzinn__"
-- Toggle K para mostrar/ocultar o menu
-- Inclui: ESP (billboards), Hitbox (invisível com clone), toggles ON/OFF funcionando corretamente,
-- otimizações para reduzir queda de FPS (event-driven + taxas configuráveis).
-- Copie apenas o conteúdo deste arquivo para o executor (não inclua as crases do Markdown).

-- =========================
-- Configurações iniciais
-- =========================
getgenv().ESPSettings = getgenv().ESPSettings or {
    Enabled = true,
    ShowLocal = false,
    MaxDistance = 2000,
    UpdateRate = 0.12, -- segundos entre updates do ESP (0 = RenderStepped)
    ShowNPCs = true,
    KeybindToggle = Enum.KeyCode.RightControl,
    BillboardName = "ESP_Billboard_v1",
    MaxNameLength = 12,
}

getgenv().HitboxSettings = getgenv().HitboxSettings or {
    Enabled = true,
    hitboxSize = 10,
    updateRate = 0.2, -- segundos entre updates do hitbox
    HitboxPartName = "ESP_Hitbox_Part",
    OriginalHeadName = "OriginalHead",
}

local ESP = getgenv().ESPSettings
local HB = getgenv().HitboxSettings

-- Serviços
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

-- Nome do menu
local MENU_NAME = "lxzinn__"
local menuScreen
local ui_espBtn, ui_hitBtn, ui_sizeBox -- referências UI

-- Estruturas gerenciadas
local playerEntries = {} -- player -> { character = Instance, head = Part, billboard = BillboardGui }
local npcEntries = {}    -- model -> { character = Instance, head = Part, billboard = BillboardGui }
local modifiedCharacters = {} -- character -> { hitboxPart, headClone, originalHeadProps }

-- UTIL
local function shortenName(name, maxLen)
    if not name then return "" end
    maxLen = maxLen or 12
    if #name > maxLen then
        return string.sub(name, 1, maxLen - 3) .. "..."
    end
    return name
end

-- =========================
-- BILLBOARD (ESP)
-- =========================
local function createBillboardForHead(head)
    if not head or not head:IsA("BasePart") then return nil end
    local existing = head:FindFirstChild(ESP.BillboardName)
    if existing and existing:IsA("BillboardGui") then
        return existing
    end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = ESP.BillboardName
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 140, 0, 28)
    billboard.StudsOffset = Vector3.new(0, 2.2, 0)
    billboard.AlwaysOnTop = true
    billboard.ResetOnSpawn = false

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    label.TextStrokeTransparency = 0
    label.Font = Enum.Font.GothamBold
    label.TextScaled = false
    label.TextSize = 16
    label.RichText = false
    label.Text = ""
    label.Parent = billboard

    billboard.Parent = head
    return billboard
end

local function setAllBillboardsEnabled(state)
    -- varredura única pelo workspace para garantir que billboards órfãos também sejam afetados
    -- essa função é chamada apenas quando o usuário togglea ESP
    for _, gui in ipairs(workspace:GetDescendants()) do
        if gui and gui:IsA("BillboardGui") and gui.Name == ESP.BillboardName then
            -- Ajusta Enabled diretamente
            gui.Enabled = state
        end
    end
end

local function setupPlayerEntry(player)
    if not player then return end
    local char = player.Character
    if not char then return end
    local head = char:FindFirstChild("Head") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso")
    if not head or not head:IsA("BasePart") then return end

    local bb = createBillboardForHead(head)
    playerEntries[player] = { character = char, head = head, billboard = bb }
    if bb then bb.Enabled = ESP.Enabled end
end

local function setupNPCEntry(model)
    if not model or not model:IsA("Model") then return end
    if Players:GetPlayerFromCharacter(model) then return end
    if not model:FindFirstChildOfClass("Humanoid") then return end
    local head = model:FindFirstChild("Head") or model:FindFirstChild("Torso") or model:FindFirstChild("UpperTorso")
    if not head or not head:IsA("BasePart") then return end
    local bb = createBillboardForHead(head)
    npcEntries[model] = { character = model, head = head, billboard = bb }
    if bb then bb.Enabled = ESP.Enabled end

    model.AncestryChanged:Connect(function(_, parent)
        if not parent then
            local entry = npcEntries[model]
            if entry and entry.head and entry.head.Parent then
                local bb2 = entry.head:FindFirstChild(ESP.BillboardName)
                if bb2 and bb2.Parent then bb2:Destroy() end
            end
            npcEntries[model] = nil
        end
    end)
end

local function cleanupPlayerEntry(player)
    local entry = playerEntries[player]
    if not entry then return end
    if entry.head and entry.head.Parent then
        local bb = entry.head:FindFirstChild(ESP.BillboardName)
        if bb and bb.Parent then bb:Destroy() end
    end
    -- remover hitbox se existir
    if entry.character and modifiedCharacters[entry.character] then
        local data = modifiedCharacters[entry.character]
        if data and data.hitboxPart and data.hitboxPart.Parent then data.hitboxPart:Destroy() end
        local head = entry.character:FindFirstChild("Head")
        if head and data and data.originalHeadProps then
            head.Size = data.originalHeadProps.Size or head.Size
            head.Transparency = data.originalHeadProps.Transparency or 0
            head.CanCollide = data.originalHeadProps.CanCollide or false
            head.Anchored = data.originalHeadProps.Anchored or false
            head.Massless = data.originalHeadProps.Massless or false
        end
        modifiedCharacters[entry.character] = nil
    end
    playerEntries[player] = nil
end

-- =========================
-- ESP Update (leve) ligado ao Heartbeat e respeitando UpdateRate
-- =========================
local espAccumulator = 0
local function espUpdate(dt)
    espAccumulator = espAccumulator + dt
    if ESP.UpdateRate > 0 and espAccumulator < ESP.UpdateRate then return end
    espAccumulator = 0

    local myPos
    if LocalPlayer and LocalPlayer.Character and LocalPlayer.Character.PrimaryPart then
        myPos = LocalPlayer.Character.PrimaryPart.Position
    end

    -- players
    for pl, entry in pairs(playerEntries) do
        if entry and entry.head and entry.head.Parent then
            local bb = entry.head:FindFirstChild(ESP.BillboardName)
            if bb and bb:IsA("BillboardGui") then
                local label = bb:FindFirstChild("Label")
                if label then
                    if pl ~= LocalPlayer or ESP.ShowLocal then
                        label.Text = shortenName(pl.Name, ESP.MaxNameLength)
                        if myPos and ESP.MaxDistance and ESP.MaxDistance > 0 then
                            local dist = (entry.head.Position - myPos).Magnitude
                            bb.Enabled = ESP.Enabled and dist <= ESP.MaxDistance
                        else
                            bb.Enabled = ESP.Enabled
                        end
                    else
                        bb.Enabled = false
                    end
                end
            end
        else
            playerEntries[pl] = nil
        end
    end

    -- npcs
    for model, entry in pairs(npcEntries) do
        if entry and entry.head and entry.head.Parent then
            local bb = entry.head:FindFirstChild(ESP.BillboardName)
            if bb and bb:IsA("BillboardGui") then
                local label = bb:FindFirstChild("Label")
                if label then
                    label.Text = shortenName(model.Name, ESP.MaxNameLength)
                    if myPos and ESP.MaxDistance and ESP.MaxDistance > 0 then
                        local dist = (entry.head.Position - myPos).Magnitude
                        bb.Enabled = ESP.Enabled and dist <= ESP.MaxDistance
                    else
                        bb.Enabled = ESP.Enabled
                    end
                end
            end
        else
            npcEntries[model] = nil
        end
    end
end

RunService.Heartbeat:Connect(function(dt)
    -- sempre checamos espUpdate para manter billboards sincronizados quando ESP.Enabled está true
    pcall(function()
        if ESP.Enabled then espUpdate(dt) end
    end)
end)

-- Cleanup periódico leve (evita GetDescendants por frame)
task.spawn(function()
    while task.wait(10) do
        for pl, entry in pairs(playerEntries) do
            if not entry or not entry.head or not entry.head.Parent then playerEntries[pl] = nil end
        end
        for model, entry in pairs(npcEntries) do
            if not entry or not entry.head or not entry.head.Parent then npcEntries[model] = nil end
        end
    end
end)

-- =========================
-- HITBOX (idempotente)
-- =========================
local function ensureHitbox(character)
    if not character or not character.Parent then return end
    local head = character:FindFirstChild("Head")
    if not head or not head:IsA("BasePart") then return end

    if modifiedCharacters[character] then
        local data = modifiedCharacters[character]
        if data.hitboxPart and data.hitboxPart.Parent then
            data.hitboxPart.Size = Vector3.new(HB.hitboxSize, HB.hitboxSize, HB.hitboxSize)
            data.hitboxPart.CFrame = head.CFrame
        end
        return
    end

    local hitboxPart = Instance.new("Part")
    hitboxPart.Name = HB.HitboxPartName
    hitboxPart.Size = Vector3.new(HB.hitboxSize, HB.hitboxSize, HB.hitboxSize)
    hitboxPart.Shape = Enum.PartType.Ball
    hitboxPart.Transparency = 1
    hitboxPart.CanCollide = false
    hitboxPart.Anchored = false
    hitboxPart.Massless = true
    hitboxPart.CFrame = head.CFrame
    hitboxPart.Parent = character

    local weldToHead = Instance.new("WeldConstraint")
    weldToHead.Part0 = hitboxPart
    weldToHead.Part1 = head
    weldToHead.Parent = hitboxPart

    local headClone = head:Clone()
    headClone.Name = HB.OriginalHeadName
    for _, child in ipairs(headClone:GetDescendants()) do
        if child:IsA("Motor6D") or child:IsA("Weld") then child:Destroy() end
    end
    headClone.Parent = hitboxPart

    local weldClone = Instance.new("WeldConstraint")
    weldClone.Part0 = headClone
    weldClone.Part1 = hitboxPart
    weldClone.Parent = headClone

    local originalHeadProps = {
        Size = head.Size,
        Transparency = head.Transparency,
        CanCollide = head.CanCollide,
        Anchored = head.Anchored,
        Massless = head.Massless,
    }

    head.Transparency = 1
    head.CanCollide = false
    head.Massless = true

    modifiedCharacters[character] = {
        hitboxPart = hitboxPart,
        headClone = headClone,
        originalHeadProps = originalHeadProps,
    }
end

local function removeHitbox(character)
    if not character or not modifiedCharacters[character] then return end
    local data = modifiedCharacters[character]
    if data.hitboxPart and data.hitboxPart.Parent then data.hitboxPart:Destroy() end
    local head = character:FindFirstChild("Head")
    if head and data.originalHeadProps then
        head.Size = data.originalHeadProps.Size or head.Size
        head.Transparency = data.originalHeadProps.Transparency or 0
        head.CanCollide = data.originalHeadProps.CanCollide or false
        head.Anchored = data.originalHeadProps.Anchored or false
        head.Massless = data.originalHeadProps.Massless or false
    end
    modifiedCharacters[character] = nil
end

-- Hitbox update loop (controlado por HB.updateRate)
task.spawn(function()
    while task.wait(HB.updateRate) do
        if HB.Enabled then
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character and player.Character.Parent then
                    local char = player.Character
                    local hum = char:FindFirstChildOfClass("Humanoid")
                    if hum and not hum.Sit then
                        pcall(ensureHitbox, char)
                    else
                        pcall(removeHitbox, char)
                    end
                end
            end
        else
            -- se desativado, remove todos
            for char, _ in pairs(modifiedCharacters) do
                pcall(removeHitbox, char)
            end
        end
    end
end)

-- =========================
-- Eventos para players & NPCs
-- =========================
for _, pl in ipairs(Players:GetPlayers()) do
    pl.CharacterAdded:Connect(function(char)
        task.wait(0.7)
        setupPlayerEntry(pl)
        if HB.Enabled and char then pcall(ensureHitbox, char) end
    end)
    pl.CharacterRemoving:Connect(function()
        cleanupPlayerEntry(pl)
    end)
    if pl.Character then
        task.spawn(function()
            task.wait(0.7)
            setupPlayerEntry(pl)
            if HB.Enabled and pl.Character then pcall(ensureHitbox, pl.Character) end
        end)
    end
end

Players.PlayerAdded:Connect(function(pl)
    pl.CharacterAdded:Connect(function(char)
        task.wait(0.7)
        setupPlayerEntry(pl)
        if HB.Enabled and char then pcall(ensureHitbox, char) end
    end)
    pl.CharacterRemoving:Connect(function(char)
        cleanupPlayerEntry(pl)
    end)
end)

if ESP.ShowNPCs then
    for _, child in ipairs(workspace:GetChildren()) do
        if child:IsA("Model") and child:FindFirstChildOfClass("Humanoid") and not Players:GetPlayerFromCharacter(child) then
            setupNPCEntry(child)
        end
    end
    workspace.ChildAdded:Connect(function(child)
        task.defer(function()
            if child:IsA("Model") and child:FindFirstChildOfClass("Humanoid") and not Players:GetPlayerFromCharacter(child) then
                setupNPCEntry(child)
            end
        end)
    end)
end

-- =========================
-- Toggles do ESP (corrigidos) e Hitbox
-- =========================
local function enableESP()
    ESP.Enabled = true
    getgenv().ESPSettings.Enabled = true

    -- ativa billboards gerenciadas
    for pl, entry in pairs(playerEntries) do
        if entry and entry.head then
            local bb = entry.head:FindFirstChild(ESP.BillboardName) or createBillboardForHead(entry.head)
            if bb then bb.Enabled = true end
        end
    end
    for model, entry in pairs(npcEntries) do
        if entry and entry.head then
            local bb = entry.head:FindFirstChild(ESP.BillboardName) or createBillboardForHead(entry.head)
            if bb then bb.Enabled = true end
        end
    end

    -- ativa também quaisquer billboards órfãos no workspace
    setAllBillboardsEnabled(true)
end

local function disableESP()
    ESP.Enabled = false
    getgenv().ESPSettings.Enabled = false

    -- desativa billboards gerenciadas
    for pl, entry in pairs(playerEntries) do
        if entry and entry.head then
            local bb = entry.head:FindFirstChild(ESP.BillboardName)
            if bb and bb:IsA("BillboardGui") then bb.Enabled = false end
        end
    end
    for model, entry in pairs(npcEntries) do
        if entry and entry.head then
            local bb = entry.head:FindFirstChild(ESP.BillboardName)
            if bb and bb:IsA("BillboardGui") then bb.Enabled = false end
        end
    end

    -- desativa quaisquer billboards órfãos no workspace também
    setAllBillboardsEnabled(false)
end

local function toggleESP()
    if ESP.Enabled then
        disableESP()
    else
        enableESP()
    end
    if ui_espBtn and ui_espBtn.Parent then ui_espBtn.Text = (ESP.Enabled and "ESP: ON" or "ESP: OFF") end
end

local function enableHB()
    HB.Enabled = true
    getgenv().HitboxSettings.Enabled = true
    for _, entry in pairs(playerEntries) do
        if entry and entry.character then pcall(ensureHitbox, entry.character) end
    end
    for _, entry in pairs(npcEntries) do
        if entry and entry.character then pcall(ensureHitbox, entry.character) end
    end
end

local function disableHB()
    HB.Enabled = false
    getgenv().HitboxSettings.Enabled = false
    for _, entry in pairs(playerEntries) do
        if entry and entry.character then pcall(removeHitbox, entry.character) end
    end
    for _, entry in pairs(npcEntries) do
        if entry and entry.character then pcall(removeHitbox, entry.character) end
    end
end

local function toggleHB()
    if HB.Enabled then disableHB() else enableHB() end
    if ui_hitBtn and ui_hitBtn.Parent then ui_hitBtn.Text = (HB.Enabled and "Hitbox: ON" or "Hitbox: OFF") end
end

-- =========================
-- MENU (CoreGui) - cria e guarda referências de botões
-- =========================
local function createMenu()
    local existing = CoreGui:FindFirstChild(MENU_NAME)
    if existing then existing:Destroy() end

    local screen = Instance.new("ScreenGui")
    screen.Name = MENU_NAME
    screen.ResetOnSpawn = false
    screen.Enabled = true
    -- tenta CoreGui; se falhar (executor), cairá no pcall de ensureMenu
    screen.Parent = CoreGui
    menuScreen = screen

    local frame = Instance.new("Frame")
    frame.Name = "Main"
    frame.Size = UDim2.new(0, 300, 0, 160)
    frame.Position = UDim2.new(0.5, -150, 0.2, 0)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.Parent = screen
    frame.Active = true
    frame.Draggable = true

    local uicorner = Instance.new("UICorner")
    uicorner.CornerRadius = UDim.new(0, 8)
    uicorner.Parent = frame

    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, 0, 0, 28)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "lxzinn__ Menu"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Parent = frame

    ui_espBtn = Instance.new("TextButton")
    ui_espBtn.Name = "ESPButton"
    ui_espBtn.Size = UDim2.new(0, 140, 0, 36)
    ui_espBtn.Position = UDim2.new(0, 10, 0, 36)
    ui_espBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    ui_espBtn.BorderSizePixel = 0
    ui_espBtn.Font = Enum.Font.Gotham
    ui_espBtn.TextSize = 14
    ui_espBtn.TextColor3 = Color3.fromRGB(255,255,255)
    ui_espBtn.Text = (ESP.Enabled and "ESP: ON" or "ESP: OFF")
    ui_espBtn.Parent = frame

    ui_hitBtn = Instance.new("TextButton")
    ui_hitBtn.Name = "HitboxButton"
    ui_hitBtn.Size = UDim2.new(0, 140, 0, 36)
    ui_hitBtn.Position = UDim2.new(0, 150, 0, 36)
    ui_hitBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    ui_hitBtn.BorderSizePixel = 0
    ui_hitBtn.Font = Enum.Font.Gotham
    ui_hitBtn.TextSize = 14
    ui_hitBtn.TextColor3 = Color3.fromRGB(255,255,255)
    ui_hitBtn.Text = (HB.Enabled and "Hitbox: ON" or "Hitbox: OFF")
    ui_hitBtn.Parent = frame

    local sizeLabel = Instance.new("TextLabel")
    sizeLabel.Name = "SizeLabel"
    sizeLabel.Size = UDim2.new(0, 80, 0, 24)
    sizeLabel.Position = UDim2.new(0, 12, 0, 84)
    sizeLabel.BackgroundTransparency = 1
    sizeLabel.Text = "Hitbox Size:"
    sizeLabel.Font = Enum.Font.Gotham
    sizeLabel.TextSize = 14
    sizeLabel.TextColor3 = Color3.fromRGB(200,200,200)
    sizeLabel.TextXAlignment = Enum.TextXAlignment.Left
    sizeLabel.Parent = frame

    ui_sizeBox = Instance.new("TextBox")
    ui_sizeBox.Name = "SizeBox"
    ui_sizeBox.Size = UDim2.new(0, 120, 0, 28)
    ui_sizeBox.Position = UDim2.new(0, 100, 0, 80)
    ui_sizeBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    ui_sizeBox.BorderSizePixel = 0
    ui_sizeBox.Font = Enum.Font.Gotham
    ui_sizeBox.TextSize = 14
    ui_sizeBox.TextColor3 = Color3.fromRGB(255,255,255)
    ui_sizeBox.Text = tostring(HB.hitboxSize)
    ui_sizeBox.ClearTextOnFocus = false
    ui_sizeBox.Parent = frame

    local applyBtn = Instance.new("TextButton")
    applyBtn.Name = "ApplyButton"
    applyBtn.Size = UDim2.new(0, 60, 0, 28)
    applyBtn.Position = UDim2.new(0, 228, 0, 80)
    applyBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    applyBtn.BorderSizePixel = 0
    applyBtn.Font = Enum.Font.Gotham
    applyBtn.TextSize = 14
    applyBtn.TextColor3 = Color3.fromRGB(255,255,255)
    applyBtn.Text = "Aplicar"
    applyBtn.Parent = frame

    local closeBtn = Instance.new("TextButton")
    closeBtn.Name = "Close"
    closeBtn.Size = UDim2.new(0, 60, 0, 22)
    closeBtn.Position = UDim2.new(1, -70, 0, 6)
    closeBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
    closeBtn.BorderSizePixel = 0
    closeBtn.Font = Enum.Font.Gotham
    closeBtn.TextSize = 12
    closeBtn.TextColor3 = Color3.fromRGB(255,255,255)
    closeBtn.Text = "Fechar"
    closeBtn.Parent = frame

    ui_espBtn.MouseButton1Click:Connect(function() toggleESP() end)
    ui_hitBtn.MouseButton1Click:Connect(function() toggleHB() end)

    applyBtn.MouseButton1Click:Connect(function()
        local text = ui_sizeBox.Text
        local num = tonumber(text)
        if num and num > 0 then
            HB.hitboxSize = num
            getgenv().HitboxSettings.hitboxSize = num
            -- aplica tamanho nas hitboxes existentes
            for _, entry in pairs(playerEntries) do
                if entry and entry.character then
                    local hit = entry.character:FindFirstChild(HB.HitboxPartName)
                    if hit and hit:IsA("BasePart") then hit.Size = Vector3.new(num, num, num) end
                end
            end
            for _, entry in pairs(npcEntries) do
                if entry and entry.character then
                    local hit = entry.character:FindFirstChild(HB.HitboxPartName)
                    if hit and hit:IsA("BasePart") then hit.Size = Vector3.new(num, num, num) end
                end
            end
        else
            ui_sizeBox.Text = tostring(HB.hitboxSize)
        end
    end)

    closeBtn.MouseButton1Click:Connect(function()
        if menuScreen and menuScreen.Parent then menuScreen.Enabled = false end
    end)

    return screen
end

local function ensureMenu()
    if menuScreen and menuScreen.Parent and menuScreen.Enabled ~= nil then return menuScreen end
    local ok, err = pcall(function() createMenu() end)
    if not ok then
        warn("[ESP+HITBOX] Não foi possível criar menu em CoreGui:", err)
        -- fallback em PlayerGui
        local fallback = Instance.new("ScreenGui")
        fallback.Name = MENU_NAME
        fallback.ResetOnSpawn = false
        fallback.Parent = LocalPlayer:WaitForChild("PlayerGui")
        menuScreen = fallback
        -- criar UI mínima no fallback para consistência
        -- not strictly necessary, mas garante referências existam
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(0, 300, 0, 160)
        frame.Position = UDim2.new(0.5, -150, 0.2, 0)
        frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
        frame.BorderSizePixel = 0
        frame.Parent = fallback
    end
    return menuScreen
end

-- Keybinds: K para menu, KeybindToggle (RightControl por default) para toggle ESP
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.K then
        if menuScreen and menuScreen.Parent then
            menuScreen.Enabled = not menuScreen.Enabled
        else
            ensureMenu()
            if menuScreen and menuScreen.Parent then menuScreen.Enabled = true end
        end
    end
    if input.KeyCode == ESP.KeybindToggle then
        toggleESP()
    end
end)

-- Create menu and initial setup
ensureMenu()

-- Inicializa entradas e hitboxes para jogadores já presentes
for _, pl in ipairs(Players:GetPlayers()) do
    if pl.Character then
        task.spawn(function()
            task.wait(0.7)
            setupPlayerEntry(pl)
            if HB.Enabled and pl.Character then pcall(ensureHitbox, pl.Character) end
        end)
    end
end

print("[ESP+HITBOX] Inicializado. Menu:", MENU_NAME, "Use K para mostrar/ocultar. ESP:", tostring(ESP.Enabled), "Hitbox:", tostring(HB.Enabled))

-- Helpers expostos (opcional)
getgenv().__lxz_helpers = {
    toggleESP = toggleESP,
    enableESP = enableESP,
    disableESP = disableESP,
    toggleHB = toggleHB,
    enableHB = enableHB,
    disableHB = disableHB,
}
